// ==========================================
// SYNAPSE BOOTSTRAP LEXER v0.1
// Phase 55, Step 2: Tokenization
// ==========================================

// --- String Utils (from bootstrap_v1) ---

fn str_len(s) {
    let i = 0
    while getbyte(s, i) > 0 {
        i = i + 1
    }
    return i
}

fn io_print(s) {
    let len = str_len(s)
    let h = getstd(-11)
    write(h, s, len)
    return 0
}

fn io_println(s) {
    io_print(s)
    let h = getstd(-11)
    let nl = alloc(1)
    setbyte(nl, 0, 10)
    write(h, nl, 1)
    return 0
}

// --- CHAR UTILS ---

fn is_digit(c) {
    // '0' = 48, '9' = 57
    if c < 48 { return 0 }
    if c > 57 { return 0 }
    return 1
}

fn is_alpha(c) {
    // 'a' = 97, 'z' = 122
    let result = 0
    if c >= 97 {
        if c <= 122 { 
            result = 1 
        }
    }
    if result == 1 { return 1 }
    
    // 'A' = 65, 'Z' = 90
    if c >= 65 {
        if c <= 90 { 
            result = 1 
        }
    }
    if result == 1 { return 1 }
    
    // '_' = 95
    if c == 95 { return 1 }
    
    return 0
}

fn is_alnum(c) {
    if is_alpha(c) == 1 { return 1 }
    if is_digit(c) == 1 { return 1 }
    return 0
}

fn is_space(c) {
    if c == 32 { return 1 }  // Space
    if c == 10 { return 1 }  // \n
    if c == 13 { return 1 }  // \r
    if c == 9  { return 1 }  // Tab
    return 0
}

// --- LEXER ---

fn tokenize(source) {
    let i = 0
    let c = 0
    let temp_buf = alloc(2)
    let running = 1
    
    // Loop while not end of string
    while running == 1 {
        c = getbyte(source, i)
        
        // End of string
        if c == 0 {
            running = 0
        }
        
        // Process only if still running
        if running == 1 {
            // 1. Skip Whitespace
            if is_space(c) == 1 {
                i = i + 1
            }
            
            // 2. Identifiers (fn, let, main...)
            if is_space(c) == 0 {
                if is_alpha(c) == 1 {
                    io_print_ident(source, i)
                    // Advance past identifier
                    while is_alnum(getbyte(source, i)) == 1 {
                        i = i + 1
                    }
                }
            }
            
            // 3. Numbers
            if is_space(c) == 0 {
                if is_alpha(c) == 0 {
                    if is_digit(c) == 1 {
                        io_print_number(source, i)
                        // Advance past number
                        while is_digit(getbyte(source, i)) == 1 {
                            i = i + 1
                        }
                    }
                }
            }
            
            // 4. Symbols (single char for now)
            if is_space(c) == 0 {
                if is_alpha(c) == 0 {
                    if is_digit(c) == 0 {
                        io_print_symbol(c)
                        i = i + 1
                    }
                }
            }
        }
    }
    return 0
}

// Print "TOKEN: IDENT -> <word>"
fn io_print_ident(source, start) {
    let prefix = alloc(16)
    // "TOKEN: IDENT -> "
    setbyte(prefix, 0, 84)   // T
    setbyte(prefix, 1, 79)   // O
    setbyte(prefix, 2, 75)   // K
    setbyte(prefix, 3, 69)   // E
    setbyte(prefix, 4, 78)   // N
    setbyte(prefix, 5, 58)   // :
    setbyte(prefix, 6, 32)   // space
    setbyte(prefix, 7, 73)   // I
    setbyte(prefix, 8, 68)   // D
    setbyte(prefix, 9, 69)   // E
    setbyte(prefix, 10, 78)  // N
    setbyte(prefix, 11, 84)  // T
    setbyte(prefix, 12, 32)  // space
    setbyte(prefix, 13, 45)  // -
    setbyte(prefix, 14, 62)  // >
    setbyte(prefix, 15, 32)  // space
    setbyte(prefix, 16, 0)
    io_print(prefix)
    
    // Print the identifier chars
    let j = start
    let ch = 0
    let buf = alloc(2)
    setbyte(buf, 1, 0)
    
    while is_alnum(getbyte(source, j)) == 1 {
        ch = getbyte(source, j)
        setbyte(buf, 0, ch)
        io_print(buf)
        j = j + 1
    }
    
    let empty = alloc(1)
    setbyte(empty, 0, 0)
    io_println(empty)
    return 0
}

// Print "TOKEN: NUMBER -> <digits>"
fn io_print_number(source, start) {
    let prefix = alloc(18)
    // "TOKEN: NUMBER -> "
    setbyte(prefix, 0, 84)   // T
    setbyte(prefix, 1, 79)   // O
    setbyte(prefix, 2, 75)   // K
    setbyte(prefix, 3, 69)   // E
    setbyte(prefix, 4, 78)   // N
    setbyte(prefix, 5, 58)   // :
    setbyte(prefix, 6, 32)   // space
    setbyte(prefix, 7, 78)   // N
    setbyte(prefix, 8, 85)   // U
    setbyte(prefix, 9, 77)   // M
    setbyte(prefix, 10, 66)  // B
    setbyte(prefix, 11, 69)  // E
    setbyte(prefix, 12, 82)  // R
    setbyte(prefix, 13, 32)  // space
    setbyte(prefix, 14, 45)  // -
    setbyte(prefix, 15, 62)  // >
    setbyte(prefix, 16, 32)  // space
    setbyte(prefix, 17, 0)
    io_print(prefix)
    
    // Print the number chars
    let j = start
    let ch = 0
    let buf = alloc(2)
    setbyte(buf, 1, 0)
    
    while is_digit(getbyte(source, j)) == 1 {
        ch = getbyte(source, j)
        setbyte(buf, 0, ch)
        io_print(buf)
        j = j + 1
    }
    
    let empty = alloc(1)
    setbyte(empty, 0, 0)
    io_println(empty)
    return 0
}

// Print "TOKEN: SYMBOL -> <char>"
fn io_print_symbol(c) {
    let prefix = alloc(18)
    // "TOKEN: SYMBOL -> "
    setbyte(prefix, 0, 84)   // T
    setbyte(prefix, 1, 79)   // O
    setbyte(prefix, 2, 75)   // K
    setbyte(prefix, 3, 69)   // E
    setbyte(prefix, 4, 78)   // N
    setbyte(prefix, 5, 58)   // :
    setbyte(prefix, 6, 32)   // space
    setbyte(prefix, 7, 83)   // S
    setbyte(prefix, 8, 89)   // Y
    setbyte(prefix, 9, 77)   // M
    setbyte(prefix, 10, 66)  // B
    setbyte(prefix, 11, 79)  // O
    setbyte(prefix, 12, 76)  // L
    setbyte(prefix, 13, 32)  // space
    setbyte(prefix, 14, 45)  // -
    setbyte(prefix, 15, 62)  // >
    setbyte(prefix, 16, 32)  // space
    setbyte(prefix, 17, 0)
    io_print(prefix)
    
    let buf = alloc(2)
    setbyte(buf, 0, c)
    setbyte(buf, 1, 0)
    io_println(buf)
    return 0
}

// --- MAIN ---

fn main() {
    // Build test source: "fn main { return 42 }"
    let code = alloc(24)
    setbyte(code, 0, 102)   // f
    setbyte(code, 1, 110)   // n
    setbyte(code, 2, 32)    // space
    setbyte(code, 3, 109)   // m
    setbyte(code, 4, 97)    // a
    setbyte(code, 5, 105)   // i
    setbyte(code, 6, 110)   // n
    setbyte(code, 7, 32)    // space
    setbyte(code, 8, 123)   // {
    setbyte(code, 9, 32)    // space
    setbyte(code, 10, 114)  // r
    setbyte(code, 11, 101)  // e
    setbyte(code, 12, 116)  // t
    setbyte(code, 13, 117)  // u
    setbyte(code, 14, 114)  // r
    setbyte(code, 15, 110)  // n
    setbyte(code, 16, 32)   // space
    setbyte(code, 17, 52)   // 4
    setbyte(code, 18, 50)   // 2
    setbyte(code, 19, 32)   // space
    setbyte(code, 20, 125)  // }
    setbyte(code, 21, 0)    // null
    
    // Header
    let hdr1 = alloc(20)
    // "--- LEXER TEST ---"
    setbyte(hdr1, 0, 45)    // -
    setbyte(hdr1, 1, 45)    // -
    setbyte(hdr1, 2, 45)    // -
    setbyte(hdr1, 3, 32)    // space
    setbyte(hdr1, 4, 76)    // L
    setbyte(hdr1, 5, 69)    // E
    setbyte(hdr1, 6, 88)    // X
    setbyte(hdr1, 7, 69)    // E
    setbyte(hdr1, 8, 82)    // R
    setbyte(hdr1, 9, 32)    // space
    setbyte(hdr1, 10, 84)   // T
    setbyte(hdr1, 11, 69)   // E
    setbyte(hdr1, 12, 83)   // S
    setbyte(hdr1, 13, 84)   // T
    setbyte(hdr1, 14, 32)   // space
    setbyte(hdr1, 15, 45)   // -
    setbyte(hdr1, 16, 45)   // -
    setbyte(hdr1, 17, 45)   // -
    setbyte(hdr1, 18, 0)
    io_println(hdr1)
    
    // "Source: "
    let src_lbl = alloc(9)
    setbyte(src_lbl, 0, 83)   // S
    setbyte(src_lbl, 1, 111)  // o
    setbyte(src_lbl, 2, 117)  // u
    setbyte(src_lbl, 3, 114)  // r
    setbyte(src_lbl, 4, 99)   // c
    setbyte(src_lbl, 5, 101)  // e
    setbyte(src_lbl, 6, 58)   // :
    setbyte(src_lbl, 7, 32)   // space
    setbyte(src_lbl, 8, 0)
    io_print(src_lbl)
    io_println(code)
    
    // "------------------"
    let sep = alloc(19)
    setbyte(sep, 0, 45)
    setbyte(sep, 1, 45)
    setbyte(sep, 2, 45)
    setbyte(sep, 3, 45)
    setbyte(sep, 4, 45)
    setbyte(sep, 5, 45)
    setbyte(sep, 6, 45)
    setbyte(sep, 7, 45)
    setbyte(sep, 8, 45)
    setbyte(sep, 9, 45)
    setbyte(sep, 10, 45)
    setbyte(sep, 11, 45)
    setbyte(sep, 12, 45)
    setbyte(sep, 13, 45)
    setbyte(sep, 14, 45)
    setbyte(sep, 15, 45)
    setbyte(sep, 16, 45)
    setbyte(sep, 17, 45)
    setbyte(sep, 18, 0)
    io_println(sep)
    
    // Tokenize!
    tokenize(code)
    
    return 0
}

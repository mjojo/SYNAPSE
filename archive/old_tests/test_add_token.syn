// Test add_token function
fn str_len(s) {
    let i = 0
    while getbyte(s, i) > 0 {
        i = i + 1
    }
    return i
}

fn io_print(s) {
    let len = str_len(s)
    let h = getstd(-11)
    write(h, s, len)
    return 0
}

fn io_println(s) {
    io_print(s)
    let h = getstd(-11)
    let nl = alloc(2)
    setbyte(nl, 0, 10)
    setbyte(nl, 1, 0)
    write(h, nl, 1)
    return 0
}

fn add_token(state, type, text_ptr) {
    let tokens_buf = state[0]
    let count = state[1]
    
    let t = alloc(16)
    t[0] = type
    t[1] = text_ptr
    
    tokens_buf[count] = t
    state[1] = count + 1
    return 0
}

fn main() {
    // Create state
    let state = alloc(24)
    state[0] = alloc(80)  // tokens_buf
    state[1] = 0           // count
    state[2] = 0           // pos
    
    // Create test strings
    let str1 = alloc(4)
    setbyte(str1, 0, 102)  // f
    setbyte(str1, 1, 110)  // n
    setbyte(str1, 2, 0)
    
    let str2 = alloc(8)
    setbyte(str2, 0, 109)  // m
    setbyte(str2, 1, 97)   // a
    setbyte(str2, 2, 105)  // i
    setbyte(str2, 3, 110)  // n
    setbyte(str2, 4, 0)
    
    // Add tokens
    add_token(state, 1, str1)
    add_token(state, 1, str2)
    
    // Check count
    let count = state[1]
    
    // Read tokens back
    let tokens_buf = state[0]
    
    let t = tokens_buf[0]
    let text = t[1]
    io_println(text)
    
    t = tokens_buf[1]
    text = t[1]
    io_println(text)
    
    return count
}

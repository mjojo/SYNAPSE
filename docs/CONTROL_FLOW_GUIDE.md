# SYNAPSE Phase 6: Control Flow Implementation Guide

## üìã –û–±–∑–æ—Ä

Phase 6 –¥–æ–±–∞–≤–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ SYNAPSE - —É—Å–ª–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –∏ —Ü–∏–∫–ª—ã. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π —à–∞–≥ –∫ –¢—å—é—Ä–∏–Ω–≥-–ø–æ–ª–Ω–æ—Ç–µ —è–∑—ã–∫–∞.

## ‚úÖ –ß—Ç–æ –£–∂–µ –ì–æ—Ç–æ–≤–æ

### 1. –¢–æ–∫–µ–Ω—ã (synapse_tokens.inc)
- `SKW_IF` (20) - if
- `SKW_ELIF` (21) - elif  
- `SKW_ELSE` (22) - else
- `SKW_WHILE` (25) - while
- `SKW_LOOP` (26) - loop
- `SKW_BREAK` (28) - break
- `SKW_CONTINUE` (29) - continue

### 2. –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –°—Ä–∞–≤–Ω–µ–Ω–∏—è
- `SOP_EQ` (20) - ==
- `SOP_NE` (21) - !=
- `SOP_LT` (22) - <
- `SOP_GT` (23) - >
- `SOP_LE` (24) - <=
- `SOP_GE` (25) - >=

### 3. AST –£–∑–ª—ã (ast.inc)
- `NODE_IF` (5) - —É—Å–ª–æ–≤–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä
- `NODE_ELIF` (6) - elif –≤–µ—Ç–∫–∞
- `NODE_ELSE` (7) - else –≤–µ—Ç–∫–∞
- `NODE_WHILE` (9) - —Ü–∏–∫–ª while
- `NODE_LOOP` (10) - –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
- `NODE_BREAK` (13) - break
- `NODE_CONTINUE` (14) - continue
- `NODE_BLOCK` (16) - –±–ª–æ–∫ –∫–æ–¥–∞

### 4. –õ–µ–∫—Å–µ—Ä (lexer_v2.asm)
- ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —á–µ—Ä–µ–∑ `synlex_check_keyword`
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–æ–≤ (INDENT/DEDENT)
- ‚úÖ –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

## üî® –ß—Ç–æ –ù—É–∂–Ω–æ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å

### 1. –ü–∞—Ä—Å–µ—Ä - –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –£—Å–ª–æ–≤–∏–π

**–§–∞–π–ª:** `src/parser_v2.asm`

#### –ù–æ–≤—ã–µ –§—É–Ω–∫—Ü–∏–∏

```asm
; -----------------------------------------------------------------------------
; parse_if_statement: –ü–∞—Ä—Å–∏–Ω–≥ if/elif/else
; –í—Ö–æ–¥: —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω = SKW_IF
; –í—ã—Ö–æ–¥: RAX = —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ NODE_IF
; -----------------------------------------------------------------------------
parse_if_statement:
    ; 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω = SKW_IF
    ; 2. Advance (–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å 'if')
    ; 3. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å —É—Å–ª–æ–≤–∏–µ (parse_condition)
    ; 4. –û–∂–∏–¥–∞—Ç—å ':' (COLON)
    ; 5. –û–∂–∏–¥–∞—Ç—å INDENT
    ; 6. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å –±–ª–æ–∫ (parse_block)
    ; 7. –û–∂–∏–¥–∞—Ç—å DEDENT
    ; 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ elif/else
    ; 9. –°–æ–∑–¥–∞—Ç—å —É–∑–µ–ª NODE_IF
    ; 10. –°–≤—è–∑–∞—Ç—å condition, then_block, else_block
    ret

; -----------------------------------------------------------------------------
; parse_condition: –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ª–æ–≤–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
; –ü—Ä–∏–º–µ—Ä—ã: x > 0, a == b, count < 10
; –í—ã—Ö–æ–¥: RAX = —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —É–∑–µ–ª –≤—ã—Ä–∞–∂–µ–Ω–∏—è (NODE_BINOP)
; -----------------------------------------------------------------------------
parse_condition:
    ; 1. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å –ª–µ–≤—ã–π –æ–ø–µ—Ä–∞–Ω–¥ (parse_primary)
    ; 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    ; 3. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å –ø—Ä–∞–≤—ã–π –æ–ø–µ—Ä–∞–Ω–¥
    ; 4. –°–æ–∑–¥–∞—Ç—å —É–∑–µ–ª NODE_BINOP —Å —Ç–∏–ø–æ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
    ret

; -----------------------------------------------------------------------------
; parse_while_statement: –ü–∞—Ä—Å–∏–Ω–≥ while —Ü–∏–∫–ª–∞
; –í—Ö–æ–¥: —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω = SKW_WHILE
; –í—ã—Ö–æ–¥: RAX = —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ NODE_WHILE
; -----------------------------------------------------------------------------
parse_while_statement:
    ; 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω = SKW_WHILE
    ; 2. Advance
    ; 3. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å —É—Å–ª–æ–≤–∏–µ
    ; 4. –û–∂–∏–¥–∞—Ç—å ':'
    ; 5. –û–∂–∏–¥–∞—Ç—å INDENT
    ; 6. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å –±–ª–æ–∫ —Ç–µ–ª–∞ —Ü–∏–∫–ª–∞
    ; 7. –û–∂–∏–¥–∞—Ç—å DEDENT
    ; 8. –°–æ–∑–¥–∞—Ç—å —É–∑–µ–ª NODE_WHILE
    ret

; -----------------------------------------------------------------------------
; parse_block: –ü–∞—Ä—Å–∏–Ω–≥ –±–ª–æ–∫–∞ –∫–æ–¥–∞ (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)
; –ë–ª–æ–∫ = –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å statements –¥–æ DEDENT
; –í—ã—Ö–æ–¥: RAX = —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ NODE_BLOCK
; -----------------------------------------------------------------------------
parse_block:
    ; 1. –°–æ–∑–¥–∞—Ç—å —É–∑–µ–ª NODE_BLOCK
    ; 2. While (—Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω != DEDENT):
    ;    - –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å statement
    ;    - –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –¥–æ—á–µ—Ä–Ω–∏—Ö —É–∑–ª–æ–≤
    ; 3. Return NODE_BLOCK
    ret
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ parse_statement

```asm
parse_statement:
    call token_type
    
    ; –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ statement
    cmp al, STOK_KEYWORD
    jne .not_keyword
    
    ; –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Ç–∏–ø–∞ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞
    call token_subtype
    
    cmp al, SKW_IF
    je parse_if_statement
    
    cmp al, SKW_WHILE
    je parse_while_statement
    
    cmp al, SKW_RETURN
    je parse_return_statement
    
    cmp al, SKW_BREAK
    je parse_break_statement
    
    cmp al, SKW_CONTINUE
    je parse_continue_statement
    
.not_keyword:
    ; ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ statements
    ret
```

### 2. –ö–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä - JIT –¥–ª—è –£—Å–ª–æ–≤–Ω—ã—Ö –ü–µ—Ä–µ—Ö–æ–¥–æ–≤

**–§–∞–π–ª:** `src/jit_control_flow.asm` (–Ω–æ–≤—ã–π)

#### –°–∏—Å—Ç–µ–º–∞ –ú–µ—Ç–æ–∫

```asm
; –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ—Ç–∫–∏
struct Label {
    qword name_hash      ; –•–µ—à –∏–º–µ–Ω–∏ –º–µ—Ç–∫–∏
    qword address        ; –ê–¥—Ä–µ—Å –≤ JIT-–±—É—Ñ–µ—Ä–µ (0 –µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞)
    qword fixup_count    ; –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
    qword fixup_list[8]  ; –°–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
}

; –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –º–µ—Ç–æ–∫
label_table:
    times 64 dq 0, 0, 0, 0, 0, 0, 0, 0, 0, 0

label_count dd 0
label_counter dd 0  ; –°—á—ë—Ç—á–∏–∫ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º—ë–Ω

; -----------------------------------------------------------------------------
; label_create: –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—É—é –º–µ—Ç–∫—É
; –í—Ö–æ–¥: RCX = –±–∞–∑–æ–≤–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "if_end")
; –í—ã—Ö–æ–¥: RAX = –∏–Ω–¥–µ–∫—Å –º–µ—Ç–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
; -----------------------------------------------------------------------------
label_create:
    ; 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è (if_end_0, if_end_1, ...)
    ; 2. –í—ã—á–∏—Å–ª—è–µ–º —Ö–µ—à
    ; 3. –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É
    ; 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω–¥–µ–∫—Å
    ret

; -----------------------------------------------------------------------------
; label_define: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–¥—Ä–µ—Å –º–µ—Ç–∫–∏
; –í—Ö–æ–¥: EAX = –∏–Ω–¥–µ–∫—Å –º–µ—Ç–∫–∏, RCX = –∞–¥—Ä–µ—Å –≤ JIT-–±—É—Ñ–µ—Ä–µ
; -----------------------------------------------------------------------------
label_define:
    ; 1. –ù–∞–π—Ç–∏ –º–µ—Ç–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
    ; 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å address = RCX
    ; 3. –î–ª—è –∫–∞–∂–¥–æ–π fixup —Å—Å—ã–ª–∫–∏:
    ;    - –í—ã—á–∏—Å–ª–∏—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
    ;    - –ó–∞–ø–∏—Å–∞—Ç—å –≤ JIT-–±—É—Ñ–µ—Ä
    ret

; -----------------------------------------------------------------------------
; label_reference: –°–æ—Å–ª–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ç–∫—É
; –í—Ö–æ–¥: EAX = –∏–Ω–¥–µ–∫—Å –º–µ—Ç–∫–∏, RCX = –∞–¥—Ä–µ—Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ JMP/JE/...
; -----------------------------------------------------------------------------
label_reference:
    ; 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ª–∏ –º–µ—Ç–∫–∞ (address != 0)
    ; 2. –ï—Å–ª–∏ –¥–∞: –≤—ã—á–∏—Å–ª–∏—Ç—å —Å–º–µ—â–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å–∞—Ç—å
    ; 3. –ï—Å–ª–∏ –Ω–µ—Ç: –¥–æ–±–∞–≤–∏—Ç—å –≤ fixup_list
    ret
```

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –£—Å–ª–æ–≤–∏–π

```asm
; -----------------------------------------------------------------------------
; jit_emit_if: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –¥–ª—è if statement
; –í—Ö–æ–¥: RAX = —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ NODE_IF
; -----------------------------------------------------------------------------
jit_emit_if:
    push rbx
    push rdi
    
    ; –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–∑–µ–ª
    mov rbx, rax
    
    ; 1. –°–æ–∑–¥–∞—ë–º –º–µ—Ç–∫–∏
    lea rcx, [label_else]
    call label_create
    mov edi, eax  ; –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å else_label
    
    lea rcx, [label_end]
    call label_create
    push rax      ; –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å end_label
    
    ; 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ —É—Å–ª–æ–≤–∏—è
    mov rax, [rbx + AST_NODE_CHILD]  ; condition node
    call jit_emit_expression
    ; –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ RAX
    
    ; 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å 0 (false)
    ; cmp rax, 0
    call jit_emit_cmp_rax_zero
    
    ; 4. –£—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ else
    ; je else_label
    mov eax, edi
    call jit_emit_je  ; –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JE —Å fixup
    
    ; 5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ then –±–ª–æ–∫–∞
    mov rax, [rbx + AST_NODE_CHILD + 8]  ; then_block
    call jit_emit_block
    
    ; 6. –ë–µ–∑—É—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ–Ω—Ü—É
    ; jmp end_label
    pop rax
    push rax
    call jit_emit_jmp
    
    ; 7. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–∫—É else
    mov eax, edi
    mov rcx, [jit_current_addr]
    call label_define
    
    ; 8. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ else –±–ª–æ–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    mov rax, [rbx + AST_NODE_CHILD + 16]  ; else_block
    test rax, rax
    jz .no_else
    
    call jit_emit_block
    
.no_else:
    ; 9. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–∫—É end
    pop rax
    mov rcx, [jit_current_addr]
    call label_define
    
    pop rdi
    pop rbx
    ret

; -----------------------------------------------------------------------------
; jit_emit_while: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –¥–ª—è while —Ü–∏–∫–ª–∞
; –í—Ö–æ–¥: RAX = —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ NODE_WHILE
; -----------------------------------------------------------------------------
jit_emit_while:
    push rbx
    push rdi
    push rsi
    
    mov rbx, rax
    
    ; 1. –°–æ–∑–¥–∞—ë–º –º–µ—Ç–∫–∏
    lea rcx, [label_loop_start]
    call label_create
    mov edi, eax  ; loop_start
    
    lea rcx, [label_loop_end]
    call label_create
    mov esi, eax  ; loop_end
    
    ; 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞—á–∞–ª–∞ —Ü–∏–∫–ª–∞
    mov eax, edi
    mov rcx, [jit_current_addr]
    call label_define
    
    ; 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ —É—Å–ª–æ–≤–∏—è
    mov rax, [rbx + AST_NODE_CHILD]  ; condition
    call jit_emit_expression
    
    ; 4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å 0
    call jit_emit_cmp_rax_zero
    
    ; 5. –í—ã—Ö–æ–¥ –∏–∑ —Ü–∏–∫–ª–∞ –µ—Å–ª–∏ false
    ; je loop_end
    mov eax, esi
    call jit_emit_je
    
    ; 6. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–ª–æ —Ü–∏–∫–ª–∞
    mov rax, [rbx + AST_NODE_CHILD + 8]  ; body
    call jit_emit_block
    
    ; 7. –ü—Ä—ã–∂–æ–∫ –≤ –Ω–∞—á–∞–ª–æ
    ; jmp loop_start
    mov eax, edi
    call jit_emit_jmp
    
    ; 8. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–∫—É –∫–æ–Ω—Ü–∞
    mov eax, esi
    mov rcx, [jit_current_addr]
    call label_define
    
    pop rsi
    pop rdi
    pop rbx
    ret
```

#### –ù–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–π

```asm
; -----------------------------------------------------------------------------
; jit_emit_cmp_rax_zero: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 'cmp rax, 0'
; -----------------------------------------------------------------------------
jit_emit_cmp_rax_zero:
    mov rdi, [jit_buffer_ptr]
    
    ; –û–ø–∫–æ–¥: 48 83 F8 00 (cmp rax, 0)
    mov byte [rdi], 0x48
    mov byte [rdi+1], 0x83
    mov byte [rdi+2], 0xF8
    mov byte [rdi+3], 0x00
    
    add rdi, 4
    mov [jit_buffer_ptr], rdi
    ret

; -----------------------------------------------------------------------------
; jit_emit_je: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å–ª–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ 'je offset'
; –í—Ö–æ–¥: EAX = –∏–Ω–¥–µ–∫—Å –º–µ—Ç–∫–∏
; -----------------------------------------------------------------------------
jit_emit_je:
    push rax
    
    mov rdi, [jit_buffer_ptr]
    
    ; –û–ø–∫–æ–¥: 0F 84 [offset 4 bytes] (je rel32)
    mov byte [rdi], 0x0F
    mov byte [rdi+1], 0x84
    
    ; –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –º–µ—Å—Ç–æ –¥–ª—è —Å–º–µ—â–µ–Ω–∏—è
    mov dword [rdi+2], 0
    
    ; –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º fixup
    add rdi, 2
    mov rcx, rdi  ; –ê–¥—Ä–µ—Å –¥–ª—è fixup
    pop rax       ; –ò–Ω–¥–µ–∫—Å –º–µ—Ç–∫–∏
    call label_reference
    
    add rdi, 4
    mov [jit_buffer_ptr], rdi
    ret

; -----------------------------------------------------------------------------
; jit_emit_jmp: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑—É—Å–ª–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ 'jmp offset'
; –í—Ö–æ–¥: EAX = –∏–Ω–¥–µ–∫—Å –º–µ—Ç–∫–∏
; -----------------------------------------------------------------------------
jit_emit_jmp:
    push rax
    
    mov rdi, [jit_buffer_ptr]
    
    ; –û–ø–∫–æ–¥: E9 [offset 4 bytes] (jmp rel32)
    mov byte [rdi], 0xE9
    mov dword [rdi+1], 0
    
    add rdi, 1
    mov rcx, rdi
    pop rax
    call label_reference
    
    add rdi, 4
    mov [jit_buffer_ptr], rdi
    ret
```

### 3. –¢–∞–±–ª–∏—Ü–∞ –°–∏–º–≤–æ–ª–æ–≤ (Symbol Table)

**–§–∞–π–ª:** `src/symbol_table.asm` (–Ω–æ–≤—ã–π)

```asm
; –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
struct Variable {
    qword name_hash      ; –•–µ—à –∏–º–µ–Ω–∏
    byte  type           ; –¢–∏–ø (int, f64, ptr)
    byte  scope_level    ; –£—Ä–æ–≤–µ–Ω—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
    word  padding
    qword address        ; –ê–¥—Ä–µ—Å –≤ —Å—Ç–µ–∫–µ/Merkle-–ø–∞–º—è—Ç–∏
}

MAX_VARIABLES = 256
variable_table:
    times MAX_VARIABLES dq 0, 0

variable_count dd 0
scope_level dd 0

; -----------------------------------------------------------------------------
; symtab_enter_scope: –£–≤–µ–ª–∏—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
; -----------------------------------------------------------------------------
symtab_enter_scope:
    inc dword [scope_level]
    ret

; -----------------------------------------------------------------------------
; symtab_exit_scope: –£–º–µ–Ω—å—à–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å, —É–¥–∞–ª–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
; -----------------------------------------------------------------------------
symtab_exit_scope:
    ; –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
    mov eax, [scope_level]
    ; ... (–∏—Ç–µ—Ä–∞—Ü–∏—è –ø–æ —Ç–∞–±–ª–∏—Ü–µ)
    
    dec dword [scope_level]
    ret

; -----------------------------------------------------------------------------
; symtab_declare: –û–±—ä—è–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
; –í—Ö–æ–¥: RCX = –∏–º—è, AL = —Ç–∏–ø, RDX = –∞–¥—Ä–µ—Å
; –í—ã—Ö–æ–¥: EAX = –∏–Ω–¥–µ–∫—Å –≤ —Ç–∞–±–ª–∏—Ü–µ (–∏–ª–∏ -1 –µ—Å–ª–∏ –æ—à–∏–±–∫–∞)
; -----------------------------------------------------------------------------
symtab_declare:
    ; 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –≤ —Ç–µ–∫—É—â–µ–º scope
    ; 2. –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É
    ; 3. –í–µ—Ä–Ω—É—Ç—å –∏–Ω–¥–µ–∫—Å
    ret

; -----------------------------------------------------------------------------
; symtab_lookup: –ù–∞–π—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ –∏–º–µ–Ω–∏
; –í—Ö–æ–¥: RCX = –∏–º—è
; –í—ã—Ö–æ–¥: RAX = —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ Variable (–∏–ª–∏ 0 –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞)
; -----------------------------------------------------------------------------
symtab_lookup:
    ; –ü–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ (–Ω–∞—á–∏–Ω–∞—è —Å —Ç–µ–∫—É—â–µ–≥–æ scope, –∑–∞—Ç–µ–º –≤—ã—à–µ)
    ret
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–±–æ—Ä–∫–∞ –¢–µ—Å—Ç–æ–≤

```batch
cd tests
fasm control_flow_test.asm
control_flow_test.exe
```

### –ü—Ä–∏–º–µ—Ä—ã –î–ª—è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–°–æ–∑–¥–∞–Ω—ã —Ñ–∞–π–ª—ã:
- `examples/control_flow_simple.syn` - –±–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
- `examples/control_flow_secure.syn` - –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å —É—Å–ª–æ–≤–∏—è–º–∏
- `tests/control_flow_test.asm` - —Ç–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä

## üìù –ü–ª–∞–Ω –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ù–µ–¥–µ–ª—è 1-2: –ü–∞—Ä—Å–µ—Ä
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `parse_condition()`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `parse_if_statement()`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `parse_while_statement()`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `parse_block()`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `parse_statement()` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- [ ] –¢–µ—Å—Ç—ã: –ø–∞—Ä—Å–∏–Ω–≥ –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –ù–µ–¥–µ–ª—è 3-4: –ö–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –º–µ—Ç–æ–∫ (Label Manager)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `jit_emit_cmp_rax_zero()`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `jit_emit_je()`, `jit_emit_jne()`, `jit_emit_jmp()`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `jit_emit_if()`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `jit_emit_while()`
- [ ] –¢–µ—Å—Ç—ã: –ø—Ä–æ—Å—Ç—ã–µ —É—Å–ª–æ–≤–∏—è (abs, max, min)

### –ù–µ–¥–µ–ª—è 5-6: –¢–∞–±–ª–∏—Ü–∞ –°–∏–º–≤–æ–ª–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Symbol Table
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –ø–∞—Ä—Å–µ—Ä–æ–º
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- [ ] –¢–µ—Å—Ç—ã: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —É—Å–ª–æ–≤–∏—è—Ö –∏ —Ü–∏–∫–ª–∞—Ö

### –ù–µ–¥–µ–ª—è 7-8: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–¥–∞
- [ ] –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã (—Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª, –§–∏–±–æ–Ω–∞—á—á–∏, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞)
- [ ] –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (MOVA Engine scenarios)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –†–µ—Å—É—Ä—Å—ã

- [PHASE_6_ROADMAP.md](PHASE_6_ROADMAP.md) - –ø–æ–ª–Ω–∞—è –¥–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞
- [SYNAPSE_SYNTAX.md](SYNAPSE_SYNTAX.md) - —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —è–∑—ã–∫–∞
- [SYNAPSE_SPEC.md](SYNAPSE_SPEC.md) - —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
- [x64 Instruction Reference](https://www.felixcloutier.com/x64/) - —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –£—Å–ø–µ—Ö–∞ Phase 6

- ‚úÖ –ü–∞—Ä—Å–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ç—Ä–æ–∏—Ç AST –¥–ª—è if/elif/else
- ‚úÖ –ü–∞—Ä—Å–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ç—Ä–æ–∏—Ç AST –¥–ª—è while
- ‚úÖ JIT –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–∞—à–∏–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è —É—Å–ª–æ–≤–∏–π
- ‚úÖ JIT –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–∞—à–∏–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ü–∏–∫–ª–æ–≤
- ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
- ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã
- ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ scope
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ Merkle Tree –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

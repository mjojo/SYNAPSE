; ============================================================================
; TITAN Language - JIT Emitter (x64 Code Generator)
; 
; (c) 2025 mjojo (Vitaly.G) & GLK-Dev
; https://github.com/GLK-Dev
;
; Функции генерации x64 машинного кода
; ============================================================================

; ============================================================================
; ФУНКЦИИ ЭМИТТЕРА
; Все функции используют RDI как указатель на текущую позицию в JIT буфере
; После записи RDI автоматически продвигается вперёд
; ============================================================================

; ----------------------------------------------------------------------------
; jit_emit_prologue - Генерирует пролог функции
; Сохраняет non-volatile регистры и выравнивает стек
; ----------------------------------------------------------------------------
jit_emit_prologue:
    ; push rbp
    mov al, 0x55
    stosb
    
    ; mov rbp, rsp  (48 89 E5)
    mov al, 0x48
    stosb
    mov al, 0x89
    stosb
    mov al, 0xE5
    stosb
    
    ; sub rsp, 40  (shadow space + выравнивание)
    mov al, 0x48
    stosb
    mov al, 0x83
    stosb
    mov al, 0xEC
    stosb
    mov al, 40
    stosb
    
    ret

; ----------------------------------------------------------------------------
; jit_emit_epilogue - Генерирует эпилог функции
; Восстанавливает стек и возвращает управление
; ----------------------------------------------------------------------------
jit_emit_epilogue:
    ; add rsp, 40
    mov al, 0x48
    stosb
    mov al, 0x83
    stosb
    mov al, 0xC4
    stosb
    mov al, 40
    stosb
    
    ; pop rbp
    mov al, 0x5D
    stosb
    
    ; ret
    mov al, 0xC3
    stosb
    
    ret

; ----------------------------------------------------------------------------
; jit_emit_mov_rax_imm64 - mov rax, imm64
; Вход: RAX = значение для загрузки
; ----------------------------------------------------------------------------
jit_emit_mov_rax_imm64:
    push rax
    ; REX.W prefix + opcode
    mov al, 0x48
    stosb
    mov al, 0xB8
    stosb
    ; immediate (8 bytes)
    pop rax
    stosq
    ret

; ----------------------------------------------------------------------------
; jit_emit_mov_rcx_imm64 - mov rcx, imm64
; Вход: RCX = значение для загрузки
; ----------------------------------------------------------------------------
jit_emit_mov_rcx_imm64:
    push rcx
    mov al, 0x48
    stosb
    mov al, 0xB9
    stosb
    pop rax
    stosq
    ret

; ----------------------------------------------------------------------------
; jit_emit_mov_rdx_imm64 - mov rdx, imm64
; Вход: RDX = значение для загрузки
; ----------------------------------------------------------------------------
jit_emit_mov_rdx_imm64:
    push rdx
    mov al, 0x48
    stosb
    mov al, 0xBA
    stosb
    pop rax
    stosq
    ret

; ----------------------------------------------------------------------------
; jit_emit_mov_r8_imm64 - mov r8, imm64
; Вход: R8 = значение для загрузки
; ----------------------------------------------------------------------------
jit_emit_mov_r8_imm64:
    push r8
    mov al, 0x49
    stosb
    mov al, 0xB8
    stosb
    pop rax
    stosq
    ret

; ----------------------------------------------------------------------------
; jit_emit_mov_r9_imm64 - mov r9, imm64
; Вход: R9 = значение для загрузки
; ----------------------------------------------------------------------------
jit_emit_mov_r9_imm64:
    push r9
    mov al, 0x49
    stosb
    mov al, 0xB9
    stosb
    pop rax
    stosq
    ret

; ----------------------------------------------------------------------------
; jit_emit_mov_eax_imm32 - mov eax, imm32
; Вход: EAX = значение (32-bit)
; ----------------------------------------------------------------------------
jit_emit_mov_eax_imm32:
    push rax
    mov al, 0xB8
    stosb
    pop rax
    stosd
    ret

; ----------------------------------------------------------------------------
; jit_emit_mov_ecx_imm32 - mov ecx, imm32
; Вход: ECX = значение (32-bit)
; ----------------------------------------------------------------------------
jit_emit_mov_ecx_imm32:
    push rcx
    mov al, 0xB9
    stosb
    pop rax
    stosd
    ret

; ----------------------------------------------------------------------------
; jit_emit_mov_edx_imm32 - mov edx, imm32  
; Вход: EDX = значение (32-bit)
; ----------------------------------------------------------------------------
jit_emit_mov_edx_imm32:
    push rdx
    mov al, 0xBA
    stosb
    pop rax
    stosd
    ret

; ----------------------------------------------------------------------------
; jit_emit_mov_r8d_imm32 - mov r8d, imm32
; Вход: R8D = значение (32-bit)
; ----------------------------------------------------------------------------
jit_emit_mov_r8d_imm32:
    push r8
    mov al, 0x41
    stosb
    mov al, 0xB8
    stosb
    pop rax
    stosd
    ret

; ----------------------------------------------------------------------------
; jit_emit_call_rax - call rax (вызов функции по адресу в RAX)
; ----------------------------------------------------------------------------
jit_emit_call_rax:
    mov al, 0xFF
    stosb
    mov al, 0xD0
    stosb
    ret

; ----------------------------------------------------------------------------
; jit_emit_call_indirect - Генерирует call [addr] через mov rax + call rax
; Вход: RAX = адрес функции
; ----------------------------------------------------------------------------
jit_emit_call_indirect:
    call jit_emit_mov_rax_imm64
    call jit_emit_call_rax
    ret

; ----------------------------------------------------------------------------
; jit_emit_push_0 - push 0 (для 5-го параметра Windows API)
; ----------------------------------------------------------------------------
jit_emit_push_0:
    mov al, 0x6A
    stosb
    mov al, 0x00
    stosb
    ret

; ----------------------------------------------------------------------------
; jit_emit_sub_rsp_imm8 - sub rsp, imm8
; Вход: AL = значение
; ----------------------------------------------------------------------------
jit_emit_sub_rsp_imm8:
    push rax
    mov al, 0x48
    stosb
    mov al, 0x83
    stosb
    mov al, 0xEC
    stosb
    pop rax
    stosb
    ret

; ----------------------------------------------------------------------------
; jit_emit_add_rsp_imm8 - add rsp, imm8
; Вход: AL = значение
; ----------------------------------------------------------------------------
jit_emit_add_rsp_imm8:
    push rax
    mov al, 0x48
    stosb
    mov al, 0x83
    stosb
    mov al, 0xC4
    stosb
    pop rax
    stosb
    ret

; ----------------------------------------------------------------------------
; jit_emit_xor_eax_eax - xor eax, eax (обнуление RAX)
; ----------------------------------------------------------------------------
jit_emit_xor_eax_eax:
    mov al, 0x31
    stosb
    mov al, 0xC0
    stosb
    ret

; ----------------------------------------------------------------------------
; jit_emit_ret - ret
; ----------------------------------------------------------------------------
jit_emit_ret:
    mov al, 0xC3
    stosb
    ret

; ----------------------------------------------------------------------------
; jit_emit_nop - nop
; ----------------------------------------------------------------------------
jit_emit_nop:
    mov al, 0x90
    stosb
    ret
